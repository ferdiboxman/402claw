name: Deploy Dispatcher Staging

on:
  push:
    branches:
      - main
    paths:
      - "prototypes/cli/**"
      - "prototypes/csv-api/**"
      - ".github/workflows/deploy-dispatcher-staging.yml"
  workflow_dispatch:
    inputs:
      script_name:
        description: "Cloudflare worker script name"
        required: true
        default: "clawr-dispatcher"
      execute:
        description: "Run real deploy (false = dry-run only)"
        required: true
        type: boolean
        default: false

concurrency:
  group: deploy-dispatcher-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy dispatcher to staging
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_DISPATCH_NAMESPACE: ${{ secrets.CLOUDFLARE_DISPATCH_NAMESPACE }}
      CLOUDFLARE_USAGE_KV_ID: ${{ secrets.CLOUDFLARE_USAGE_KV_ID }}
      CLOUDFLARE_RATE_KV_ID: ${{ secrets.CLOUDFLARE_RATE_KV_ID }}
    defaults:
      run:
        working-directory: prototypes/cli

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: prototypes/cli/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Resolve deploy parameters
        id: params
        env:
          AUTO_EXECUTE: ${{ vars.CLOUDFLARE_STAGING_AUTO_EXECUTE }}
        run: |
          script_name="clawr-dispatcher"
          execute="false"

          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            dispatch_script_name="$(jq -r '.inputs.script_name // empty' "$GITHUB_EVENT_PATH")"
            dispatch_execute="$(jq -r '.inputs.execute // "false"' "$GITHUB_EVENT_PATH")"
            if [[ -n "$dispatch_script_name" ]]; then
              script_name="$dispatch_script_name"
            fi
            if [[ "$dispatch_execute" == "true" ]]; then
              execute="true"
            fi
          elif [[ "$GITHUB_EVENT_NAME" == "push" && "${AUTO_EXECUTE,,}" == "true" ]]; then
            execute="true"
          fi

          echo "script_name=$script_name" >> "$GITHUB_OUTPUT"
          echo "execute=$execute" >> "$GITHUB_OUTPUT"

      - name: Check required secrets
        id: secrets
        run: |
          missing=()
          [[ -n "$CLOUDFLARE_ACCOUNT_ID" ]] || missing+=("CLOUDFLARE_ACCOUNT_ID")
          [[ -n "$CLOUDFLARE_API_TOKEN" ]] || missing+=("CLOUDFLARE_API_TOKEN")
          [[ -n "$CLOUDFLARE_DISPATCH_NAMESPACE" ]] || missing+=("CLOUDFLARE_DISPATCH_NAMESPACE")

          if (( ${#missing[@]} > 0 )); then
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "missing=${missing[*]}" >> "$GITHUB_OUTPUT"
          else
            echo "ready=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Fail manual run when required secrets are missing
        if: ${{ github.event_name == 'workflow_dispatch' && steps.secrets.outputs.ready != 'true' }}
        run: |
          echo "Missing required secrets: ${{ steps.secrets.outputs.missing }}"
          exit 1

      - name: Skip deploy when required secrets are missing
        if: ${{ github.event_name != 'workflow_dispatch' && steps.secrets.outputs.ready != 'true' }}
        run: echo "Skipping staging deploy: missing required secrets (${{ steps.secrets.outputs.missing }})."

      - name: Deploy dry-run
        if: ${{ steps.secrets.outputs.ready == 'true' }}
        run: |
          args=(
            cloudflare-deploy-dispatcher
            --script-name "${{ steps.params.outputs.script_name }}"
            --account-id "$CLOUDFLARE_ACCOUNT_ID"
            --api-token "$CLOUDFLARE_API_TOKEN"
            --dispatch-namespace "$CLOUDFLARE_DISPATCH_NAMESPACE"
          )
          if [[ -n "$CLOUDFLARE_USAGE_KV_ID" ]]; then
            args+=(--usage-kv-id "$CLOUDFLARE_USAGE_KV_ID")
          fi
          if [[ -n "$CLOUDFLARE_RATE_KV_ID" ]]; then
            args+=(--rate-kv-id "$CLOUDFLARE_RATE_KV_ID")
          fi
          node src/index.js "${args[@]}"

      - name: Deploy execute
        if: ${{ steps.secrets.outputs.ready == 'true' && steps.params.outputs.execute == 'true' }}
        run: |
          args=(
            cloudflare-deploy-dispatcher
            --script-name "${{ steps.params.outputs.script_name }}"
            --account-id "$CLOUDFLARE_ACCOUNT_ID"
            --api-token "$CLOUDFLARE_API_TOKEN"
            --dispatch-namespace "$CLOUDFLARE_DISPATCH_NAMESPACE"
            --execute
          )
          if [[ -n "$CLOUDFLARE_USAGE_KV_ID" ]]; then
            args+=(--usage-kv-id "$CLOUDFLARE_USAGE_KV_ID")
          fi
          if [[ -n "$CLOUDFLARE_RATE_KV_ID" ]]; then
            args+=(--rate-kv-id "$CLOUDFLARE_RATE_KV_ID")
          fi
          node src/index.js "${args[@]}"
