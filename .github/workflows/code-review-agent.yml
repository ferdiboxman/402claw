name: Code Review Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PR_NUMBER="${{ inputs.pr_number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          gh pr diff $PR_NUMBER > pr_diff.txt
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run code review
        id: review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const diff = fs.readFileSync('pr_diff.txt', 'utf8');
            
            // Simple heuristic checks (replace with actual review agent like Greptile/CodeRabbit)
            const findings = [];
            
            // Check for common issues
            if (diff.includes('console.log')) {
              findings.push({
                severity: 'warning',
                message: 'Found console.log statements - consider removing for production'
              });
            }
            
            if (diff.includes('TODO') || diff.includes('FIXME')) {
              findings.push({
                severity: 'info',
                message: 'Found TODO/FIXME comments - ensure these are tracked'
              });
            }
            
            if (diff.includes('any') && (diff.includes('.ts') || diff.includes('.tsx'))) {
              findings.push({
                severity: 'warning',
                message: 'Found "any" type - consider using specific types'
              });
            }
            
            if (diff.match(/password|secret|api.?key/i) && !diff.includes('.env')) {
              findings.push({
                severity: 'critical',
                message: 'Potential hardcoded secret detected - review carefully'
              });
            }
            
            // Store findings
            fs.writeFileSync('review_findings.json', JSON.stringify(findings, null, 2));
            
            return findings;

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const findings = JSON.parse(fs.readFileSync('review_findings.json', 'utf8'));
            const headSha = '${{ github.event.pull_request.head.sha }}';
            
            const severityEmoji = {
              critical: 'üî¥',
              warning: 'üü°',
              info: '‚ÑπÔ∏è'
            };
            
            let body = `## ü§ñ Code Review Agent

            **Commit:** \`${headSha.slice(0, 7)}\`
            **Findings:** ${findings.length}

            `;
            
            if (findings.length === 0) {
              body += '‚úÖ No issues found!\n';
            } else {
              body += '### Findings\n\n';
              for (const f of findings) {
                body += `${severityEmoji[f.severity]} **${f.severity.toUpperCase()}**: ${f.message}\n\n`;
              }
            }
            
            body += `\n<!-- code-review-agent-sha:${headSha} -->`;
            
            // Find or update existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const marker = '<!-- code-review-agent-sha:';
            const existingComment = comments.data.find(c => c.body.includes(marker));
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Fail on critical findings
        run: |
          if grep -q '"severity": "critical"' review_findings.json; then
            echo "::error::Critical issues found in code review"
            exit 1
          fi
