# Cloudflare Workers for Platforms Deep Dive

## Executive Summary
Workers for Platforms (W4P) is a strong fit for 402claw because it gives multi-tenant isolation, dynamic per-tenant routing, and API-driven deployment of user code. The biggest design work is not deployment itself, but controlling runaway cost and abuse with custom limits, observability, and policy around outbound calls.

## Key Findings
- W4P is explicitly designed for running untrusted customer/AI-generated code in isolated Workers.
- Core control plane is: dispatch namespace + dynamic dispatch worker + user workers (+ optional outbound worker).
- Cloudflare documents "unlimited number of workers" in dispatch namespaces and recommends one namespace per environment, not per customer.
- Per-customer guardrails are native (`limits: { cpuMs, subRequests }` when dispatching).
- Current Workers pricing/limits are materially different from many older blog posts; use latest docs baselines.
- Paid plan baseline is simple enough for MVP economics modeling (request + CPU overages, plus minimum monthly account charge).

## Detailed Analysis

### 1. Why W4P Fits 402claw
W4P value proposition maps directly to 402claw requirements:
- untrusted code execution sandbox
- per-tenant isolation
- one platform endpoint that dispatches to many tenant apps
- programmable routing and platform middleware layer

Cloudflare docs now explicitly mention running code written by customers or generated by AI in isolated sandboxes.

### 2. Architecture Pattern for 402claw
Recommended baseline:
1. `dispatcher` worker receives request.
2. resolve tenant/app slug from hostname/path.
3. fetch tenant worker via `env.DISPATCHER.get(workerName, ..., { limits })`.
4. run preflight platform logic:
   - auth/API key checks
   - x402 paywall check for protected routes
   - policy checks (denylist, quota)
5. invoke tenant worker.
6. optionally run outbound worker controls for egress.

Use one namespace per environment (`staging`, `production`), not per customer.

### 3. Programmatic Deployment of User Code
Cloudflare starter kit and docs show direct API-driven model:
- platform accepts user code
- uploads user worker script into dispatch namespace
- dispatcher routes requests by worker name/path/subdomain

Bindings can be attached at deploy/update time (KV, D1, R2, Durable Objects, etc.) via metadata in multipart worker upload.

### 4. Isolation Model and Security Considerations
From docs:
- user workers in namespace run isolated from each other,
- resource access is binding-scoped (explicitly attached only),
- optional outbound worker can enforce egress policy.

MVP policy recommendation:
- default deny outbound except allowlisted domains.
- separate platform secrets from tenant-bound secrets.
- per-tenant binding allocation strategy:
  - shared for low-cost tiers,
  - dedicated binding resources for paid tiers.

### 5. Cost Model (Current as of 2026-02 docs)
Workers pricing doc states:
- paid plan minimum monthly account charge (`$5`).
- standard model includes `10M` requests/month then `$0.30` per additional million.
- CPU pool includes `30M` CPU ms/month then `$0.02` per additional million CPU ms.
- no duration charge itself; CPU is key variable.

Limits doc currently states (paid):
- subrequests up to `10,000/request`.
- worker size `10 MB`.
- memory `128 MB`.
- CPU per HTTP request up to 5 minutes (default lower unless configured).

This is materially more permissive than old assumptions and increases importance of custom per-tenant limits to avoid expensive abuse.

### 6. Cost Optimization Strategies for 402claw
- Enforce custom limits per request from dispatch layer (`cpuMs`, `subRequests`).
- Tiered limits by subscription plan.
- Require explicit opt-in for high-CPU/high-subrequest endpoints.
- Use Smart Placement for backend-heavy routes to reduce tail latency and compute waste.
- Use Hyperdrive for external Postgres/MySQL to avoid repeated connection setup overhead.
- Split static/public docs to asset/CDN paths, keep worker CPU for paid dynamic calls only.

### 7. Observability Requirements
W4P observability guidance supports:
- namespace-wide log capture via dispatch worker configuration,
- Tail Workers for near-real-time processing,
- Analytics Engine/GraphQL for usage metrics.

For 402claw, minimum telemetry dimensions:
- `tenant_id`, `worker_name`, `route`, `payment_required`, `payment_success`, `settlement_result`, `cpu_ms`, `subrequests`, `status_code`, `error_code`.

### 8. Practical Risks
- Billing blowups from recursive fetch loops or accidental fan-out.
- Inconsistent tenant code quality causing noisy error volumes.
- Dispatch key ambiguity (host/path parsing edge cases).
- Inadequate abuse controls (bot storms) if x402 challenge is on expensive path.

## Code Examples

### Example A: Dynamic dispatch with plan-based limits
```js
export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const tenant = url.hostname.split(".")[0];
    const plan = await env.PLANS.get(tenant);

    const limits = plan === "pro"
      ? { cpuMs: 200, subRequests: 50 }
      : { cpuMs: 50, subRequests: 10 };

    const userWorker = env.DISPATCHER.get(tenant, {}, { limits });
    return userWorker.fetch(request);
  },
};
```

### Example B: Route-level placement hint in Wrangler
```toml
[placement]
mode = "smart"
```

## Recommendations
- Commit to W4P for MVP runtime and ship with one dispatch namespace per environment.
- Make custom limits mandatory from day one; do not defer to post-MVP.
- Start with path-based routing for simplicity, then add hostname/custom-domain routing.
- Add outbound worker egress control before opening public uploads.
- Model unit economics using latest request+CPU prices and measure real CPU per paid request in staging.

## Sources
- https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/
- https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/get-started/
- https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/how-workers-for-platforms-works/
- https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/configuration/dynamic-dispatch/
- https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/configuration/custom-limits/
- https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/configuration/bindings/
- https://developers.cloudflare.com/cloudflare-for-platforms/workers-for-platforms/configuration/observability/
- https://developers.cloudflare.com/workers/platform/pricing/
- https://developers.cloudflare.com/workers/platform/limits/
- https://developers.cloudflare.com/workers/configuration/placement/
- https://developers.cloudflare.com/hyperdrive/
- https://developers.cloudflare.com/workers/observability/
- See `research/claude-research/402claw-final-mvp-plan.md` for earlier hosting decision rationale.
